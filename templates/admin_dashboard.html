<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - IFA System</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/login_icon.png') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Specific Dashboard Styles */
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: var(--primary-light);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(15, 76, 129, 0.2);
        }

        .option-item {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .option-item:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-sm);
        }
    </style>
</head>

<body>
    <div class="dashboard-header">
        <div class="d-flex align-center gap-20">
            <h1 class="dashboard-title"><i class="fas fa-file-invoice" style="margin-right: 10px;"></i> IFA Admin</h1>
        </div>
        <div class="d-flex align-center gap-20">
            <span style="font-weight: 500; color: var(--text-muted);"><i class="fas fa-user-shield"></i> Welcome,
                Admin</span>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>

    <div class="container fade-in">
        <!-- Dropdown Management Section -->
        <div class="card mb-20">
            <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.25rem;">
                <i class="fas fa-sliders-h" style="color: var(--accent-color);"></i> Manage Dropdown Options
            </h2>

            <!-- Category Tabs -->
            <div class="dropdown-tabs"
                style="display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; overflow-x: auto;">
                <button class="tab-btn active" data-category="to_person">To Person</button>
                <button class="tab-btn" data-category="project_name">Project Name</button>
                <button class="tab-btn" data-category="prepared_by">Prepared By</button>
                <button class="tab-btn" data-category="approved_by">Approved By</button>
            </div>

            <!-- Dropdown Options Display -->
            <div id="dropdownOptionsContainer" style="min-height: 200px;">
                <div class="text-center" style="padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-spinner fa-spin"
                        style="font-size: 2rem; margin-bottom: 10px; color: var(--accent-color);"></i>
                    <p>Loading options...</p>
                </div>
            </div>

            <!-- Add New Option Form -->
            <div id="addOptionForm"
                style="margin-top: 25px; padding: 20px; background: var(--bg-body); border-radius: var(--radius-md); display: none;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="newOptionValue" placeholder="Enter new option value..." style="flex: 1;">
                    <button id="btnAddOption" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
                    <button id="btnCancelAdd" class="btn btn-secondary">Cancel</button>
                </div>
            </div>

            <button id="btnShowAddForm" class="btn btn-primary mt-20">
                <i class="fas fa-plus-circle"></i> Add New Option
            </button>
        </div>

        <!-- IFA Submissions Section -->
        <div class="d-flex justify-between align-center mb-20" style="margin-top: 40px;">
            <h2 style="margin: 0; font-size: 1.5rem; color: var(--primary-dark);">Submitted Invoices</h2>
            <div style="position: relative; width: 300px;">
                <i class="fas fa-search"
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                <input type="text" id="searchInput" placeholder="Search IFA No, Supplier..."
                    style="padding-left: 35px;">
            </div>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>IFA No</th>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Project</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ifa in ifas %}
                    <tr class="clickable-row" data-href="{{ url_for('view_ifa', id=ifa.id) }}"
                        onclick="window.location.href=this.dataset.href;">
                        <td>
                            <div class="d-flex align-center gap-10">
                                <div
                                    style="width: 8px; height: 8px; background: var(--success-color); border-radius: 50%;">
                                </div>
                                <span style="font-weight: 600; color: var(--primary-dark);">{{ ifa.ifa_no }}</span>
                            </div>
                        </td>
                        <td>{{ ifa.ifa_date }}</td>
                        <td>{{ ifa.supplier_name }}</td>
                        <td>
                            <span
                                style="background: var(--primary-light); color: var(--primary-color); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">
                                {{ ifa.project_name }}
                            </span>
                        </td>
                        <td>
                            <a href="{{ url_for('view_ifa', id=ifa.id) }}" class="btn btn-primary"
                                style="padding: 6px 16px; font-size: 0.85rem;">
                                <i class="fas fa-eye" style="margin-right: 5px;"></i> View / Edit
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 60px; color: var(--text-muted);">
                            <i class="far fa-folder-open"
                                style="font-size: 3rem; margin-bottom: 15px; color: var(--border-color);"></i>
                            <p>No submissions found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts preserved from original functionality -->
    <script>
        // Global variables
        let currentCategory = 'to_person';
        let allDropdownOptions = {};

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadDropdownOptions();
            setupTabSwitching();
            setupAddOptionForm();
        });

        // Setup tab switching
        function setupTabSwitching() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // Update active tab
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Update current category
                    currentCategory = this.getAttribute('data-category');
                    displayOptions(currentCategory);
                });
            });
        }

        // Load all dropdown options
        function loadDropdownOptions() {
            fetch('/admin/dropdown-options')
                .then(response => response.json())
                .then(data => {
                    allDropdownOptions = data;
                    displayOptions(currentCategory);
                })
                .catch(error => {
                    console.error('Error loading dropdown options:', error);
                    document.getElementById('dropdownOptionsContainer').innerHTML =
                        '<div class="text-center" style="padding: 40px; color: var(--danger-color);"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Error loading options</p></div>';
                });
        }

        // Display options for a category
        function displayOptions(category) {
            const container = document.getElementById('dropdownOptionsContainer');
            const options = allDropdownOptions[category] || [];

            if (options.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: var(--text-muted);"><i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; color: var(--border-color);"></i><p>No options yet. Add one below!</p></div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
            options.forEach(opt => {
                html += `
                    <div class="option-item" data-id="${opt.id}" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 20px;">
                        <span class="option-value" style="flex: 1; font-weight: 500; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-check-circle" style="color: var(--success-color); font-size:0.8rem;"></i> ${opt.value}
                        </span>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editOption(${opt.id}, '${opt.value.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" title="Edit">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button onclick="deleteOption(${opt.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Setup add option form
        function setupAddOptionForm() {
            document.getElementById('btnShowAddForm').addEventListener('click', function () {
                document.getElementById('addOptionForm').style.display = 'block';
                this.style.display = 'none';
                document.getElementById('newOptionValue').focus();
            });

            document.getElementById('btnCancelAdd').addEventListener('click', function () {
                document.getElementById('addOptionForm').style.display = 'none';
                document.getElementById('btnShowAddForm').style.display = 'inline-block';
                document.getElementById('newOptionValue').value = '';
            });

            document.getElementById('btnAddOption').addEventListener('click', addNewOption);

            document.getElementById('newOptionValue').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    addNewOption();
                }
            });
        }

        // Add new option
        function addNewOption() {
            const value = document.getElementById('newOptionValue').value.trim();
            if (!value) {
                alert('Please enter a value');
                return;
            }

            fetch('/admin/dropdown-option/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    category: currentCategory,
                    value: value
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    // Add to local data
                    if (!allDropdownOptions[currentCategory]) {
                        allDropdownOptions[currentCategory] = [];
                    }
                    allDropdownOptions[currentCategory].push(data);

                    // Reset form
                    document.getElementById('newOptionValue').value = '';
                    document.getElementById('addOptionForm').style.display = 'none';
                    document.getElementById('btnShowAddForm').style.display = 'inline-block';

                    // Refresh display
                    displayOptions(currentCategory);
                })
                .catch(error => {
                    console.error('Error adding option:', error);
                    alert('Error adding option');
                });
        }

        // Edit option
        function editOption(id, currentValue) {
            const newValue = prompt('Edit option:', currentValue);
            if (!newValue || newValue === currentValue) {
                return;
            }

            fetch(`/admin/dropdown-option/${id}/edit`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    value: newValue
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    // Update local data
                    const option = allDropdownOptions[currentCategory].find(o => o.id === id);
                    if (option) {
                        option.value = newValue;
                    }

                    // Refresh display
                    displayOptions(currentCategory);
                })
                .catch(error => {
                    console.error('Error editing option:', error);
                    alert('Error editing option');
                });
        }

        // Delete option
        function deleteOption(id) {
            if (!confirm('Are you sure you want to delete this option?')) {
                return;
            }

            fetch(`/admin/dropdown-option/${id}/delete`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        return;
                    }

                    // Remove from local data
                    allDropdownOptions[currentCategory] = allDropdownOptions[currentCategory].filter(o => o.id !== id);

                    // Refresh display
                    displayOptions(currentCategory);
                })
                .catch(error => {
                    console.error('Error deleting option:', error);
                    alert('Error deleting option');
                });
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', function () {
            var input, filter, table, tr, td, i, j, txtValue;
            input = document.getElementById('searchInput');
            filter = input.value.toUpperCase();
            table = document.querySelector('.modern-table');
            tr = table.getElementsByTagName('tr');

            for (i = 1; i < tr.length; i++) { // Skip header
                // Check if it's the "No submissions" row
                if (tr[i].getElementsByTagName('td').length === 1) continue;

                tr[i].style.display = 'none';
                td = tr[i].getElementsByTagName('td');
                for (j = 0; j < td.length; j++) {
                    if (td[j]) {
                        txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            tr[i].style.display = '';
                            break;
                        }
                    }
                }
            }
        });
    </script>
</body>

</html>